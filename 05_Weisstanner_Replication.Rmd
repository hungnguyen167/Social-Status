---
title: "05 Weisstanner Replication"
output:
  html_document:
    df_print: paged
---

Need to subset original analysis to match predicted analysis

```{r setup}
pacman::p_load("tidyverse", 
               "countrycode",
               "readstata13",
               "lme4",
               "sjPlot")

options(scipen = 999, digits = 3)
knitr::opts_chunk$set(message = F, warning = F)
```

## Data

```{r loaddata}
df_macro <- readRDS(here::here("data", "df_macro.RDS"))
df_na <- readRDS(here::here("data", "df_na.RDS"))
df_rep <- readstata13::read.dta13(here::here("weisstanner_replication","REPLICATION DATA","AbsRel_FINAL_REP.dta"))

# select out heuristic vars
df_macro <- df_macro %>%
  dplyr::select(iso3c, wave, libZ_i, lib_redistZ_i, noconf_govZ_i, cpiZ_i)
#merge
# NA and age selection

df_rep <- df_rep %>%
  subset(!is.na(redist3) & age > 17 & age < 66) %>%
  mutate(iso3c = countrycode(country, "country.name", "iso3c"),
         redist_ineq = ifelse(incdiff == "Strongly agree", 5, ifelse(incdiff == "Agree", 4, ifelse(incdiff == "Neither nor", 3, ifelse(incdiff == "Disagree", 2, ifelse(incdiff == "Strongly disagree", 1, NA)))))) %>%
  left_join(df_macro, by = c("iso3c","wave"))

```


## Original Model

Results are identical as those when running the xtreg Stata command using the modified original code

```{r omodel}

m02 <- lmer(redist_dum ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + unemp + socexp + gini_mkt + gdppc + (1 | cwave), data = subset(df_rep, !is.na(df_rep$libZ_i)))

m03 <- lmer(redist_dum ~ relgr5_wa + absgr5_wa*hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + unemp + socexp + gini_mkt + gdppc + (1 | cwave), data = subset(df_rep, !is.na(df_rep$libZ_i)))

#summary(m02)
```

## Original Model Stripped

We test removing the country level variables given that we now have only 36 country-wave units. Results for absolute and relative are nearly identical, therefore we proceed with this model for parsimony. We remove GDP also (see note in next chunk)

```{r omodel_strip}
m02s <- lmer(redist_dum ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + (1 | cwave), data = subset(df_rep, !is.na(df_rep$libZ_i)))

#summary(m02s)
```

Replicated Results
```{r mouts}
tab_model(m02, m03, p.style = "stars", show.ci = F)
```

## Heuristics Added

## Models

### First Association

We first observe that government heuristics associate with support for government redistribution.

We also remove GDP because these are all rich countries, and we've seen in both our models and in his models, that GDP is not a strong predictor, but it introduces endogeneity due to its correlation with our heuristic variables. 

Something striking is that people in more corrupt societies are more likely to support government redistribution.

#### Models

```{r hmodel}
m04_1 <- lmer(redist_dum ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + libZ_i + (1 | cwave), data = subset(df_rep, !is.na(df_rep$libZ_i))) 

m04_2 <- lmer(redist_dum ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + lib_redistZ_i + (1 | cwave), data = subset(df_rep, !is.na(df_rep$libZ_i)))

m04_3 <- lmer(redist_dum ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + noconf_govZ_i + (1 | cwave), data = subset(df_rep, !is.na(df_rep$libZ_i)))

m04_4 <- lmer(redist_dum ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + cpiZ_i + (1 | cwave), data = subset(df_rep, !is.na(df_rep$libZ_i)))

```

#### Results

```{r hmodeltab}
tab_model(m04_1, m04_2, m04_3, m04_4, p.style = "stars", show.ci = F)
```

### Add Att to Inequality

This of course removes the effects we aim to recover, but demonstrates that even when absolute and relative are in the model, we can still observe the impact of government heuristics (negative in all cases for these rich countries)

#### Models

```{r hmodeli}
m04_1i <- lmer(redist_dum ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + redist_ineq*libZ_i + (1 | cwave), data = df_rep) 

m04_2i <- lmer(redist_dum ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + redist_ineq*lib_redistZ_i + (1 | cwave), data = df_rep)

m04_3i <- lmer(redist_dum ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + redist_ineq*noconf_govZ_i + (1 | cwave), data = df_rep)

m04_4i <- lmer(redist_dum ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + redist_ineq*cpiZ_i + (1 | cwave), data = df_rep)

```

#### Results

```{r hmodeltabi}
tab_model(m04_1i, m04_2i, m04_3i, m04_4i, p.style = "stars", show.ci = F)
```

### Counterfactual Gov Support

We now calculate the predicted association based on heuristic and att to inequality.

#### Prediction Models

```{r hmodelp}
m04_1p <- lm(redist_dum ~ factor(wave) + redist_ineq*libZ_i + (1 | cwave), data = df_rep) 

m04_2p <- lm(redist_dum ~ factor(wave) + redist_ineq*lib_redistZ_i + (1 | cwave), data = df_rep)

m04_3p <- lm(redist_dum ~ factor(wave) + redist_ineq*noconf_govZ_i + (1 | cwave), data = df_rep)

m04_4p <- lm(redist_dum ~ factor(wave) + redist_ineq*cpiZ_i + (1 | cwave), data = df_rep)
# create dataframe where heuristics are lowest

df_rep_x <- df_rep %>%
  mutate(libZ_i = -2,
         lib_redistZ_i = -2,
         noconf_govZ_i = -2,
         cpiZ_i = -1.5)

# get predicted values
df_rep$redist_dum_a1 <- predict.lm(m04_1p, newdata = df_rep_x)

df_rep$redist_dum_a2 <- predict.lm(m04_2p, newdata = df_rep_x)

df_rep$redist_dum_b <- predict.lm(m04_3p, newdata = df_rep_x)

df_rep$redist_dum_c <- predict.lm(m04_4p, newdata = df_rep_x)

#trim into categories
df_rep <- df_rep %>%
  mutate(redist_dum_a1 = ifelse(redist_dum_a1 < 0, 0, ifelse(redist_dum_a1 > 1, 1, redist_dum_a1)),
         redist_dum_libZ_i = round(redist_dum_a1, 0),
         redist_dum_a2 = ifelse(redist_dum_a2 < 0, 0, ifelse(redist_dum_a2 > 1, 1, redist_dum_a2)),
         redist_dum_libZ_redist_i = round(redist_dum_a2, 0),
         redist_dum_b = ifelse(redist_dum_b < 0, 0, ifelse(redist_dum_b > 1, 1, redist_dum_b)),
         redist_dum_notrust = round(redist_dum_b, 0),
         redist_dum_c = ifelse(redist_dum_c < 0, 0, ifelse(redist_dum_c > 1, 1, redist_dum_c)),
         redist_dum_cpi = round(redist_dum_c, 0))

```

#### Replication Models

```{r expansion}
m02_rep_a1 <- lmer(redist_dum_libZ_i ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + unemp + socexp + gini_mkt + gdppc + (1 | cwave), data = df_rep)

m02_rep_a2 <- lmer(redist_dum_libZ_redist_i ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + unemp + socexp + gini_mkt + gdppc + (1 | cwave), data = df_rep)

m02_rep_b <- lmer(redist_dum_notrust ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + unemp + socexp + gini_mkt + gdppc + (1 | cwave), data = df_rep)

m02_rep_c <- lmer(redist_dum_cpi ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + unemp + socexp + gini_mkt + gdppc + (1 | cwave), data = df_rep)
```

#### Results

```{r hmodeltabp}
tab_model(m02_rep_a1, m02_rep_a2, m02_rep_b, m02_rep_c, p.style = "stars", show.ci = F)
```

## Compare Margins

We use Stata to compare our new marginal graphs with those of the original study.

See file "AbsRel_4_Models_Adjusted.do"

```{r stata_export}
#make smaller
df_rep <- df_rep %>%
  select(-c(radright_vote_re,radright_vote_pro,radright_aff,radleft_vote_re,radleft_vote_pro,radleft_aff,radright,radleft,popcentre_vote_re,popcentre_vote_pro,popcentre_aff,popcentre))

save.dta13(df_rep, here::here("weisstanner_replication", "REPLICATION DATA", "AbsRel_ADJUSTED.dta"))
```
