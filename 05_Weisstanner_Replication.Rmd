---
title: "05 Weisstanner Replication"
output:
  html_document:
    df_print: paged
---
Cannot knit in current format because of the source() call, fix eventually.

```{r setup}
pacman::p_load("tidyverse", 
               "countrycode",
               "readstata13",
               "lme4",
               "sjPlot",
               "ragg")

options(scipen = 999, digits = 3)
knitr::opts_chunk$set(message = F, warning = F)
```

## Data

```{r loaddata}
df_macro <- readRDS(here::here("data", "df_macro.RDS"))
df_na <- readRDS(here::here("data", "df_na.RDS"))
df_rep <- readstata13::read.dta13(here::here("weisstanner_replication","REPLICATION DATA","AbsRel_FINAL_REP.dta"))

# select out heuristic vars
df_macro <- df_macro %>%
  dplyr::select(iso3c, wave, libZ_i, lib_redistZ_i, noconf_govZ_i, cpiZ_i)
#merge
# NA and age selection

df_rep <- df_rep %>%
  subset(!is.na(redist3) & age > 17 & age < 66) %>%
  mutate(iso3c = countrycode(country, "country.name", "iso3c"),
         redist_ineq = ifelse(incdiff == "Strongly agree", 5, ifelse(incdiff == "Agree", 4, ifelse(incdiff == "Neither nor", 3, ifelse(incdiff == "Disagree", 2, ifelse(incdiff == "Strongly disagree", 1, NA)))))) %>%
  left_join(df_macro, by = c("iso3c","wave"))

```


## Original Model

Results are identical as those when running the xtreg Stata command using the modified original code

```{r omodel}

m02 <- lmer(redist_dum ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + unemp + socexp + gini_mkt + gdppc + (1 | cwave), data = subset(df_rep, !is.na(df_rep$libZ_i)))

m03 <- lmer(redist_dum ~ relgr5_wa + absgr5_wa*hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + unemp + socexp + gini_mkt + gdppc + (1 | cwave), data = subset(df_rep, !is.na(df_rep$libZ_i)))

#summary(m02)
```

## Original Model Stripped

We test removing the country level variables given that we now have only 36 country-wave units. Results for absolute and relative are nearly identical, therefore we proceed with this model for parsimony. We remove GDP also (see note in next chunk)

```{r omodel_strip}
m02s <- lmer(redist_dum ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + (1 | cwave), data = subset(df_rep, !is.na(df_rep$libZ_i)))

#summary(m02s)
```

Replicated Results
```{r mouts}
tab_model(m02, m03, p.style = "stars", show.ci = F)
```

## Heuristics Added

## Models

### First Association

We first observe that government heuristics associate with support for government redistribution.

We also remove GDP because these are all rich countries, and we've seen in both our models and in his models, that GDP is not a strong predictor, but it introduces endogeneity due to its correlation with our heuristic variables. 

Something striking is that people in more corrupt societies are more likely to support government redistribution.

#### Models

```{r hmodel}
m04_1 <- lmer(redist_dum ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + libZ_i + (1 | cwave), data = subset(df_rep, !is.na(df_rep$libZ_i))) 

m04_2 <- lmer(redist_dum ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + lib_redistZ_i + (1 | cwave), data = subset(df_rep, !is.na(df_rep$libZ_i)))

m04_3 <- lmer(redist_dum ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + noconf_govZ_i + (1 | cwave), data = subset(df_rep, !is.na(df_rep$libZ_i)))

m04_4 <- lmer(redist_dum ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + cpiZ_i + (1 | cwave), data = subset(df_rep, !is.na(df_rep$libZ_i)))

```

#### Results

```{r hmodeltab}
tab_model(m04_1, m04_2, m04_3, m04_4, p.style = "stars", show.ci = F)
```

### Add Att to Inequality

This of course removes the effects we aim to recover, but demonstrates that even when absolute and relative are in the model, we can still observe the impact of government heuristics (negative in all cases for these rich countries)

#### Models

```{r hmodeli}
m04_1i <- lmer(redist_dum ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + redist_ineq*libZ_i + (1 | cwave), data = df_rep) 

m04_2i <- lmer(redist_dum ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + redist_ineq*lib_redistZ_i + (1 | cwave), data = df_rep)

m04_3i <- lmer(redist_dum ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + redist_ineq*noconf_govZ_i + (1 | cwave), data = df_rep)

m04_4i <- lmer(redist_dum ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + redist_ineq*cpiZ_i + (1 | cwave), data = df_rep)

```

#### Results

```{r hmodeltabi}
tab_model(m04_1i, m04_2i, m04_3i, m04_4i, p.style = "stars", show.ci = F)
```

### Counterfactual Gov Support

We now calculate the predicted association based on heuristic and att to inequality.

#### Prediction Models

```{r hmodelp}
m04_1p <- lm(redist_dum ~ factor(wave) + redist_ineq*libZ_i + (1 | cwave), data = df_rep) 

m04_2p <- lm(redist_dum ~ factor(wave) + redist_ineq*lib_redistZ_i + (1 | cwave), data = df_rep)

m04_3p <- lm(redist_dum ~ factor(wave) + redist_ineq*noconf_govZ_i + (1 | cwave), data = df_rep)

m04_4p <- lm(redist_dum ~ factor(wave) + redist_ineq*cpiZ_i + (1 | cwave), data = df_rep)
# create dataframe where heuristics are lowest

df_rep_x <- df_rep %>%
  mutate(libZ_i = -2,
         lib_redistZ_i = -2,
         noconf_govZ_i = -2,
         cpiZ_i = -1.5)

# get predicted values
df_rep$redist_dum_a1 <- predict.lm(m04_1p, newdata = df_rep_x)

df_rep$redist_dum_a2 <- predict.lm(m04_2p, newdata = df_rep_x)

df_rep$redist_dum_b <- predict.lm(m04_3p, newdata = df_rep_x)

df_rep$redist_dum_c <- predict.lm(m04_4p, newdata = df_rep_x)

#trim into categories
df_rep <- df_rep %>%
  mutate(redist_dum_a1 = ifelse(redist_dum_a1 < 0, 0, ifelse(redist_dum_a1 > 1, 1, redist_dum_a1)),
         redist_dum_libZ_i = round(redist_dum_a1, 0),
         redist_dum_a2 = ifelse(redist_dum_a2 < 0, 0, ifelse(redist_dum_a2 > 1, 1, redist_dum_a2)),
         redist_dum_libZ_redist_i = round(redist_dum_a2, 0),
         redist_dum_b = ifelse(redist_dum_b < 0, 0, ifelse(redist_dum_b > 1, 1, redist_dum_b)),
         redist_dum_notrust = round(redist_dum_b, 0),
         redist_dum_c = ifelse(redist_dum_c < 0, 0, ifelse(redist_dum_c > 1, 1, redist_dum_c)),
         redist_dum_cpi = round(redist_dum_c, 0))

```

#### Replication Models

```{r expansion}
m02_rep_a1 <- lmer(redist_dum_libZ_i ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + unemp + socexp + gini_mkt + gdppc + (1 | cwave), data = df_rep)

m02_rep_a2 <- lmer(redist_dum_libZ_redist_i ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + unemp + socexp + gini_mkt + gdppc + (1 | cwave), data = df_rep)

m02_rep_b <- lmer(redist_dum_notrust ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + unemp + socexp + gini_mkt + gdppc + (1 | cwave), data = df_rep)

m02_rep_c <- lmer(redist_dum_cpi ~ absgr5_wa*relgr5_wa + hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + unemp + socexp + gini_mkt + gdppc + (1 | cwave), data = df_rep)
```

#### Results

```{r hmodeltabp}
tab_model(m02_rep_a1, m02_rep_a2, m02_rep_b, m02_rep_c, p.style = "stars", show.ci = F)
```


### M03 with new DV
```{r replication_new}
# for decile figure
m03lib <- lmer(redist_dum_libZ_i ~ relgr5_wa + absgr5_wa*hinc_decile + factor(educ_tert) + female + age + factor(unemployed) + factor(wave) + unemp + socexp + gini_mkt + gdppc + (1 | cwave), data = subset(df_rep, !is.na(df_rep$libZ_i)))

tab_model(m03, m03lib, p.style = "stars", show.ci = F)
```
## Compare Margins

We use Stata to compare our new marginal graphs with those of the original study.

See file "AbsRel_4_Models_Adjusted.do"

```{r stata_export}
#make smaller

df_rep <- df_rep %>%
  select(c(redist_dum_libZ_i, redist_dum, redist_dum_libZ_redist_i, redist_dum_notrust, redist_dum_cpi, absgr5_wa, relgr5_wa, hinc_decile, educ_tert, female, age, unemployed, wave, unemp, socexp, gini_mkt, gdppc, incdiff, iso3c, cwave))

save.dta13(df_rep, here::here("weisstanner_replication", "REPLICATION DATA", "AbsRel_ADJUSTED.dta"))

rm(df_rep_x)
```

Case study USA and FIN

Liberal values are very strong in USA, we can build a counterfactual to see how absolute and relative inequality affects income deciles.

```{r prep_usa}
# 1st idea was to map values
df_rep_p <- df_rep %>%
  mutate(hinc_3 = ifelse(hinc_decile == 1 | hinc_decile == 2, 1,
                  ifelse(hinc_decile == 4 | hinc_decile == 5, 2,
                  ifelse(hinc_decile == 9 | hinc_decile == 10, 3, NA)))) %>%
  subset(iso3c = "USA") %>%
  select(hinc_3, absgr5_wa, relgr5_wa, redist_dum, redist_dum_libZ_i, redist_dum_libZ_redist_i, redist_dum_notrust, redist_dum_cpi, wave) %>%
  group_by(hinc_3, wave) %>%
  summarise_all(c(mean, sd), na.rm = T) %>%
  subset(!is.na(hinc_3)) %>%
  mutate(hinc_cat = ifelse(hinc_3 == 1, "Low",
                    ifelse(hinc_3 == 2, "Mid",
                    ifelse(hinc_3 == 3, "High"))),
         label = paste(hinc_cat,wave, sep = "_"))

```

### Call margins function

```{r marginfunc}
source(here::here("weisstanner_replication", "margin_function.R"))
```

#### Fig 6A USA Orig
```{r plot_usa}
agg_png(here::here("weisstanner_replication","REPLICATION DATA","results","Fig6a.png"), width = 550, height = 500, res = 144)
df_rep_marg%>%
  ggplot() +
  #USA
  geom_point(aes(x = factor(hinc_decile), y = redist_usa, color = lib)) +
  geom_errorbar(aes(x = factor(hinc_decile), ymin = redist_usa-(redist_usa_sd), ymax = redist_usa+(redist_usa_sd), color = lib), width = 0.2) +
  theme_classic() +
  labs(x = "Income Decile", y = "Average Marginal\nSupport for Redistribution", color = "Liberal Values I") +
  scale_color_manual(values = c("#39568CFF",
                                "#3CBB75FF")) +
  scale_y_continuous(labels = scales::percent,
                     limits = 0:100) +
  theme(
    legend.position = "none"
  )
dev.off()

knitr::include_graphics(here::here("weisstanner_replication","REPLICATION DATA","results","Fig6a.png"))
```
#### Fig 6B USA Low Abs
```{r plot_usa_lo}
agg_png(here::here("weisstanner_replication","REPLICATION DATA","results","Fig6b.png"), width = 550, height = 600, res = 144)
df_rep_marg%>%
  ggplot() +
  #USA
  geom_point(aes(x = factor(hinc_decile), y = redist_usa_lo, color = lib)) +
  geom_errorbar(aes(x = factor(hinc_decile), ymin = redist_usa_lo-(redist_usa_lo_sd), ymax = redist_usa_lo+(redist_usa_lo_sd), color = lib), width = 0.2) +
  theme_classic() +
  labs(x = "Income Decile", y = "Average Marginal\nSupport for Redistribution", color = "Liberal\nValues I") +
  scale_color_manual(values = c("#39568CFF",
                                "#3CBB75FF")) +
  scale_y_continuous(labels = scales::percent,
                     limits = 0:100) +
  guides(color = guide_legend(nrow = 2)) +
  theme(legend.position = "bottom")
dev.off()

knitr::include_graphics(here::here("weisstanner_replication","REPLICATION DATA","results","Fig6b.png"))
```
#### Fig 6C FIN Orig
```{r plot_fin}
agg_png(here::here("weisstanner_replication","REPLICATION DATA","results","Fig6c.png"), width = 525, height = 500, res = 144)
df_rep_marg%>%
  ggplot() +
  #FIN
  geom_point(aes(x = factor(hinc_decile), y = redist_fin, color = lib)) +
  geom_errorbar(aes(x = factor(hinc_decile), ymin = redist_fin-(redist_fin_sd), ymax = redist_fin+(redist_fin_sd), color = lib), width = 0.2) +
  theme_classic() +
  ylim(0.15,1) +
  labs(x = "Income Decile", y = "", color = "Liberal Values I") +
  scale_color_manual(values = c("#453781FF",
                                "#20A387FF")) +
    scale_y_continuous(labels = scales::percent,
                     limits = 0:100) +
  theme(
    legend.position = "none"
  )
dev.off()

knitr::include_graphics(here::here("weisstanner_replication","REPLICATION DATA","results","Fig6c.png"))

```
### Fig 6D FIN Abs Low
```{r plot_fin_lo}
agg_png(here::here("weisstanner_replication","REPLICATION DATA","results","Fig6d.png"), width = 525, height = 600, res = 144)
df_rep_marg%>%
  ggplot() +
  #USA
  geom_point(aes(x = factor(hinc_decile), y = redist_fin_lo, color = lib)) +
  geom_errorbar(aes(x = factor(hinc_decile), ymin = redist_fin_lo-(redist_fin_lo_sd), ymax = redist_fin_lo+(redist_fin_lo_sd), color = lib), width = 0.2) +
  theme_classic() +
  labs(x = "Income Decile", y = "", color = "Liberal\nValues I") +
  scale_color_manual(values = c("#453781FF",
                                "#20A387FF")) +
  scale_y_continuous(labels = scales::percent,
                     limits = 0:100) +
  guides(color = guide_legend(nrow = 2)) +
  theme(legend.position = "bottom",
        legend.box = "vertical") 
dev.off()

knitr::include_graphics(here::here("weisstanner_replication","REPLICATION DATA","results","Fig6d.png"))


```