---
title: "R Notebook"
output:
  pdf_document: default
  html_notebook: default
---
**This is a replication of Svallfors (1997)** 

**Research Question:** How are attitudes to redistribution structured in various welfare state regimes?

**Data:** ISSP, wave of 1992, module on Social Inequality 

**Country Cases:** Swe, Nor, Ger, Aut, Aus, Nz, Can, USA

```{r}
rm(list = ls())
```


```{r setup,include=FALSE}

library(pacman)

pacman::p_load("dplyr","tidyverse","knitr","haven","car","plyr","data.table","expss","htmlTable","magrittr","ltm","questionr","survey","remotes","stargazer","lavaan","ltm")

#remotes::install_github("DiogoFerrari/occupar")
library(occupar)


wd <- "S:/Für meine Gruppen/Public Opinion and Social Policy/Hung's/OpPol/Data/ISSP/Social Inequality/"

wd <- "C:/data/"

```


This is where we import the data

```{r readdata, include=FALSE}
socIn92 <- read_dta(paste(wd,"ZA2310.dta",sep=""))

```

In the following we replicate the operationalization of the independent variable of this study: attitudes to redistribution. 

3 questions/variables from the survey are used: 

1. It is the responsibility of the government to reduce the differences between people with high incomes and those with low incomes? --> v57

2. The government should provide a job for everyone who wants one? --> v59

3. The government should provide everyone with a guaranteed basic income? --> v62

Furthermore, we reconstruct the variable "government index" as follows: 

*“For this purpose, an additive index was constructed from the three items, dividing between 'strongly agree' and 'agree' (2); 'neither agree nor disagree' (1); and ‘disagree' and 'strongly disagree' (0). These items were summed, creating an index which may vary between 0 and 6, where 0 means disagreeing with all three propositions and thereby endorsing a clear-cut anti-interventionist stand and 6 means a strong interventionist standpoint“* (Svallfors 1997: 289). 

Having created and recoded theses 4 variables, we replicate table 1 and table 2 of his study.

This is how we proceed in detail: 
```{r, echo = T}
#First we copy the dataset (first line). Now we have the original version (SocIn92) and a copied version with which we can work (SocIn92recode). In the latter we create new variables (dplyr:mutate) by recoding (car::recode) the above mentioned variables following Svallfors . 

socIn92recode <- socIn92 %>%  
  dplyr::mutate(
    r1= car::recode(socIn92$v57,recodes = '1:2=2; 3=1; 4:5=0'),
    r2= car::recode(socIn92$v59,recodes = '1:2=2; 3=1; 4:5=0'),
    r3= car::recode(socIn92$v62,recodes = '1:2=2; 3=1; 4:5=0'),
      
#Here we create Svallfors additive index "govermental index". Cases with at least one                               NA value are automatically excluded. 

     govIndex = r1+ r2+ r3,   

#to measure the percentage of people agreeing (answer category 1 and 2). Needed for table 1.     
 
    r1p= car::recode(socIn92$v57,recodes = '1:2=100; 3:5=0'), 
    r2p= car::recode(socIn92$v59,recodes = '1:2=100; 3:5=0'),
    r3p= car::recode(socIn92$v62,recodes = '1:2=100; 3:5=0')
  )%>%
  
#Now we reduce our dataset to the countries Svallfors includes in his analysis (dyplr:filter).
  
   dplyr::filter(
     v3 %in% c(2,5,17,6,1,16,9,10)  
     )

 #We remove all cases with NA values in the variables (complete.cases)

socIn92recode<-socIn92recode[complete.cases(socIn92recode$r1p),]
socIn92recode<-socIn92recode[complete.cases(socIn92recode$r2p),]
socIn92recode<-socIn92recode[complete.cases(socIn92recode$r3p),]

#Now that we have prepared our variables, we start constructing **table 1: Attitudes to redistribution in eight nations**:

#First, we creat vectors with the country means of our variables r1p, r2p, r3p (tapply).

govinc<-tapply(socIn92recode$r1p,socIn92recode$v3,mean) 
govjobs<-tapply(socIn92recode$r2p,socIn92recode$v3,mean)
govbas<-tapply(socIn92recode$r3p,socIn92recode$v3,mean)


#We make a table in form of a dataframe with the just created vectors (rbind) and sort the columns of the table following Svallfors.

table1<-as.data.frame(rbind(govinc,govjobs,govbas))
table1<-table1[,c(6,5,2,4,1,7,8,3)]   


# We creat a vector with the country names in the same order (->cnt) and a vector with the questions belonging to the variables (-> item.table1). The first is used as column names, the latter as row names. 

cnt<-c("Swe","Nor","Ger","Aut","Aus","NZ","Can","USA") 
item.table1<-c("It is the responsibility of the government to reduce the differences between people with high incomes and those with low incomes?","The government should provide a job for everyone who wants one?","The government should provide everyone with a guaranteed basic income?")

row.names(table1)<-item.table1
colnames(table1) = cnt
#Finally, we creat a HTML table (knitr:kable).

knitr::kable(table1,format="html", digits = round(1), caption = "Table 1. Attitudes to redistribution in eight nations. Percentage agreeing with certain propositions")




```
```{r, echo = T}
#Lisa's way for table 1 with weights 

socIn92recode<-socIn92recode %>%
  group_by(v3)%>% 
  dplyr::mutate(
    wmean_r1p = weighted.mean(r1p,v176),
    wmean_r2p = weighted.mean(r2p,v176),
    wmean_r3p = weighted.mean(r3p,v176))

govinc_w<-tapply(socIn92recode$wmean_r1p,socIn92recode$v3,mean) 
govjobs_w<-tapply(socIn92recode$wmean_r2p,socIn92recode$v3,mean)
govbas_w<-tapply(socIn92recode$wmean_r3p,socIn92recode$v3,mean)  

table1_w<-as.data.frame(rbind(govinc_w,govjobs_w,govbas_w))
table1_w<-table1_w[,c(6,5,2,4,1,7,8,3)]  

row.names(table1_w)<-item.table1
colnames(table1_w) = cnt

knitr::kable(table1_w,format="html", digits = round(1), caption = "Table 1 (with weights). Attitudes to redistribution in eight nations. Percentage agreeing with certain propositions")
```

```{r, echo = T}
#Hung's way for table 1 with weights
table1.2 <- round(as.data.frame(sapply(list(10,9,2,6,1,16,17,5), function(x) {
  d <<- socIn92recode[which(socIn92recode$v3 == x),]
  sapply(list(d$r1p,d$r2p,d$r3p), function(y) weighted.mean(y,d$v176)
  )})),2)
colnames(table1.2) <- c("Swe","Nor","Ger","Aut","Aus","NZ","Can","USA")

```


```{r measurement1, echo=T}

#Here we replicate **tabel 2: Index distribution**  in the same way we constructed table 1. 

#mean and standard deviation 
govIndexmean<-tapply(socIn92recode$govIndex,socIn92recode$v3,mean)
govIndexsd<-tapply(socIn92recode$govIndex,socIn92recode$v3,sd)

#cronbach's alpha by country (here for the recoded variable r1,r2,r3 = 394:396!)
a <- list(1,2,5,6,9,10,16,17)
cronalpha <- round(unlist(as.data.frame(sapply(a, function(x) {
  c <-socIn92recode[which(socIn92recode$v3 == x),c(394:396)]
  cronbach.alpha(c)
}))[1,]),2)
table2[3,] <- cronalpha

table2<-as.data.frame(rbind(govIndexmean,govIndexsd,cronalpha))
table2<-table2[,c(6,5,2,4,1,7,8,3)]

item.table2<-c("Mean","Standard Deviation", "Cronbach's alpha")
row.names(table2)<- item.table2
colnames(table2)<- cnt 


knitr::kable(table2,format="html", digits = round(2), caption = "Table 2. Government Index. Distributions")




```



```{r measurement2, echo = T}
# Remove missings to use ML estimator

socIn92M <- as.data.frame(dplyr::select(socIn92, v57, v59, v62, v3))
socIn92M <- na.omit(socIn92M)
socIn92recodeM <- dplyr::select(socIn92recode, r1p, r2p, r3p, v3)
socIn92recodeM <- as.data.frame(na.omit(socIn92recodeM))

# Also remove attributes or some lavaan functions do not work
socIn92M[] = c(socIn92M, recursive=TRUE)
socIn92recodeM[] = c(socIn92recodeM, recursive=TRUE)
# Test Svallfors
m_sval <- 'att_sval =~ r1p + r2p + r3p' #need to fix all parameters to 1
m_sval1 <- 'att_sval1 =~ 1*r1p + 1*r2p + 1*r3p'
m_norm <- 'att_norm =~ v57 + v59 + v62'

fit_sval <- cfa(m_sval, data = socIn92recodeM)
fit_sval1 <- cfa(m_sval1, data = socIn92recodeM)
fit_norm <- cfa(m_norm, data = socIn92M)

summary(fit_sval, fit.measures=TRUE)
inspect(fit_sval,what="std")$lambda
#This command merges the predicted factor scores into the original data
fs_sval <- lavPredict(fit_sval)
idx <- lavInspect(fit_sval, "case.idx")
for (fs in colnames(fs_sval)) {
  socIn92recodeM[idx, fs] <- fs_sval[ , fs]
}


summary(fit_sval1, fit.measures=TRUE)
inspect(fit_sval1,what="std")$lambda
fs_sval1 <- lavPredict(fit_sval1)
idx <- lavInspect(fit_sval1, "case.idx")
for (fs in colnames(fs_sval1)) {
  socIn92recodeM[idx, fs] <- fs_sval1[ , fs]
}
# Need to compare predicted fs to see if it is identical to Svallfors' additive scale


summary(fit_norm, fit.measures=TRUE)
inspect(fit_norm,what="std")$lambda
fs_norm <- lavPredict(fit_norm)
idx <- lavInspect(fit_norm, "case.idx")
for (fs in colnames(fs_norm)) {
  socIn92M[idx, fs] <- fs_norm[ , fs]
}

# Run SEMs to test if the items predict the various factors (i.e., predict the distributions); then compare fit


```


```{r compareT1, echo = T}
#Now we want to compare our results for table 1 with the results of Svallfors 

#Here we create a copy of table 1 with the original values of Svallfors

table1Sval<-data.frame(matrix(c(53.7,74.1,45.5,60.0,78.3,78.4,65.5,66.3, 58.1,69.5,72.1,51.2, 42.6, 39.4, 50.9, 53.1, 49.1, 60.5, 47.9, 40.1, 48.6, 38.3, 47.1, 34.2),nrow = 3,ncol = 8))
row.names(table1Sval)<-item.table1
colnames(table1Sval) = cnt

#Here we show the deviations of our replicated table (table1) and the original table (table1Sval).
table1diff <- round(table1 - table1Sval,1)

#Here we show the deviations of our replicated table (table1 with weights) and the original table (table1Sval).

table1diff_w <- round(table1_w - table1Sval,1)
```



```{r EGP, include = T, echo = T}
#here we replicate the class scheme

#we thought we could get the scheme from the cumulative ISSP 

socIncum <- read_dta(paste(wd, "ZA5890_v1-0-0.dta", sep = ""))
socIn92new <- socIncum[which(socIncum$V5 %in% c(752, 578, 276, 40, 36, 554, 124, 840) & socIncum$V4 == 1992),] 
socIn92new <- socIn92new[,c("V3","ISCO88")]

#but there are no ISCO88 codes for 1992 so we are stuck with the Swedish coding
#It uses NYK 'Nordic Occupational Classification System

socIn92new <- dplyr::rename(socIn92new, v2 = V3)

newdata <- as.data.frame(left_join(socIn92recode, socIn92new, by = "v2"))

newdata$v110 <- car::recode(newdata$v110, recodes = '2=0')

#Here is the NYK scheme for Sweden (variable s106)
#It appears that Svallfors' original data was SEI classification (2-digit), but that provided in the ISSP from GESIS is NYK83
#we use Erik Bihagen's translation of NYK into ISCO88 [although they are not perfectly transferrable!!] http://www.camsis.stir.ac.uk/occunits/SwedishNYK8590majgpsv1.sps

newdata$isco88se <- car::recode(newdata$s106, recodes = "
                                 1 = 2141; 
                                 2 = 2143; 
                                 3 = 2144; 
                                 4 = 2145; 
                                 5 = 3116; 
                                 6 = 3117; 
                                 7 = 2142; 
                                 8 = 2148; 
                                 9 = 3119; 
                                 12 = 3211; 
                                 13 = 3211; 
                                 14 = 2114; 
                                 15 = 2112; 
                                 16 = 2113; 
                                 19 = 3111; 
                                 21 = 2211; 
                                 22 = 3213; 
                                 23 = 3213; 
                                 29 = 2211; 
                                 30 = 1210; 
                                 31 = 2310; 
                                 32 = 2320; 
                                 33 = 2331; 
                                 34 = 2320; 
                                 35 = 2359; 
                                 36 = 2320; 
                                 37 = 2352; 
                                 39 = 2359; 
                                 41 = 2460; 
                                 49 = 3480; 
                                 51 = 2421; 
                                 52 = 2429; 
                                 53 = 2429; 
                                 54 = 2429; 
                                 59 = 2429; 
                                 61 = 2451; 
                                 62 = 1234; 
                                 63 = 1229; 
                                 69 = 2451; 
                                 71 = 2452; 
                                 72 = 3471; 
                                 73 = 3471; 
                                 74 = 3131; 
                                 75 = 3474; 
                                 76 = 2453; 
                                 77 = 2455; 
                                 79 = 2455; 
                                 91 = 2432; 
                                 92 = 2431; 
                                 99 = 2446; 
                                 101 = 2221; 
                                 102 = 2230; 
                                 103 = 3231; 
                                 104 = 3232; 
                                 105 = 3133; 
                                 106 = 5132; 
                                 107 = 5132; 
                                 109 = 9132; 
                                 111 = 3226; 
                                 112 = 2229; 
                                 119 = 3226; 
                                 121 = 2222; 
                                 122 = 3225; 
                                 123 = 3225; 
                                 129 = 3225; 
                                 131 = 2224; 
                                 139 = 3228; 
                                 141 = 2223; 
                                 149 = 3227; 
                                 151 = 2446; 
                                 152 = 1228; 
                                 153 = 5131; 
                                 154 = 5133; 
                                 155 = 1228; 
                                 159 = 2446; 
                                 161 = 3152; 
                                 162 = 3151; 
                                 169 = 3152; 
                                 191 = 2445; 
                                 192 = 3223; 
                                 199 = 3460; 
                                 201 = 1110; 
                                 202 = 3443; 
                                 203 = 3444; 
                                 209 = 1110; 
                                 211 = 2419; 
                                 212 = 3431; 
                                 219 = 2419; 
                                 221 = 2412; 
                                 222 = 3423; 
                                 229 = 2412; 
                                 231 = 2411; 
                                 232 = 2411; 
                                 239 = 4121; 
                                 241 = 4115; 
                                 242 = 4111; 
                                 249 = 4190; 
                                 251 = 2131; 
                                 252 = 3122; 
                                 259 = 3121; 
                                 261 = 2441; 
                                 262 = 2122; 
                                 269 = 2441; 
                                 291 = 4190; 
                                 292 = 4122; 
                                 293 = 3412; 
                                 294 = 3412; 
                                 295 = 4221; 
                                 296 = 3422; 
                                 297 = 1317; 
                                 299 = 4190; 
                                 311 = 3471; 
                                 312 = 3413; 
                                 313 = 3419; 
                                 319 = 3419; 
                                 321 = 3416; 
                                 331 = 1314; 
                                 332 = 5220; 
                                 333 = 5220; 
                                 339 = 5220; 
                                 399 = 5220; 
                                 400 = 1311; 
                                 401 = 6112; 
                                 402 = 6130; 
                                 403 = 6130; 
                                 404 = 6130; 
                                 405 = 6130; 
                                 406 = 6129; 
                                 409 = 6112; 
                                 411 = 6112; 
                                 412 = 6121; 
                                 413 = 6112; 
                                 414 = 6129; 
                                 419 = 6121; 
                                 421 = 6154; 
                                 431 = 6152; 
                                 432 = 6151; 
                                 439 = 6152; 
                                 441 = 6141; 
                                 449 = 6141; 
                                 501 = 7111; 
                                 509 = 7111; 
                                 511 = 8113; 
                                 521 = 8121; 
                                 531 = 8155; 
                                 599 = 7111; 
                                 601 = 3142; 
                                 602 = 3142; 
                                 603 = 3141; 
                                 609 = 3142; 
                                 611 = 8340; 
                                 612 = 8340; 
                                 619 = 8340; 
                                 621 = 3143; 
                                 629 = 3143; 
                                 631 = 8311; 
                                 640 = 8322; 
                                 641 = 8324; 
                                 642 = 8322; 
                                 643 = 9151; 
                                 649 = 8334; 
                                 651 = 3144; 
                                 652 = 5112; 
                                 653 = 5111; 
                                 659 = 5112; 
                                 661 = 4133; 
                                 662 = 3144; 
                                 663 = 8312; 
                                 664 = 4133; 
                                 669 = 4133; 
                                 671 = 4142; 
                                 673 = 3132; 
                                 674 = 3132; 
                                 675 = 3132; 
                                 679 = 4142; 
                                 681 = 4142; 
                                 682 = 9151; 
                                 689 = 4142; 
                                 691 = 4133; 
                                 699 = 9330; 
                                 701 = 8261; 
                                 702 = 7332; 
                                 703 = 7432; 
                                 705 = 8262; 
                                 706 = 7435; 
                                 707 = 3152; 
                                 709 = 7332; 
                                 711 = 7433; 
                                 712 = 7434; 
                                 713 = 7433; 
                                 714 = 7437; 
                                 715 = 7435; 
                                 716 = 7433; 
                                 719 = 7436; 
                                 721 = 7442; 
                                 722 = 7442; 
                                 723 = 8268; 
                                 729 = 8269; 
                                 731 = 8121; 
                                 732 = 8122; 
                                 733 = 8122; 
                                 735 = 7215; 
                                 736 = 7221; 
                                 737 = 7211; 
                                 739 = 8122; 
                                 741 = 7311; 
                                 742 = 7311; 
                                 743 = 3224; 
                                 744 = 3211; 
                                 745 = 7313; 
                                 746 = 7323; 
                                 749 = 7222; 
                                 751 = 8211; 
                                 752 = 7233; 
                                 753 = 7231; 
                                 754 = 7213; 
                                 755 = 7136; 
                                 756 = 7212; 
                                 757 = 7214; 
                                 758 = 8223; 
                                 759 = 7214; 
                                 761 = 7241; 
                                 762 = 7241; 
                                 763 = 8282; 
                                 764 = 7244; 
                                 765 = 7245; 
                                 766 = 3131; 
                                 769 = 8282; 
                                 771 = 6141; 
                                 772 = 8141; 
                                 773 = 8240; 
                                 775 = 7331; 
                                 776 = 7331; 
                                 777 = 7423; 
                                 779 = 8141; 
                                 781 = 7141; 
                                 782 = 7132; 
                                 783 = 7141; 
                                 789 = 7139; 
                                 791 = 7122; 
                                 793 = 7123; 
                                 794 = 7124; 
                                 795 = 7134; 
                                 796 = 7135; 
                                 799 = 7129; 
                                 801 = 7341; 
                                 802 = 7343; 
                                 803 = 8251; 
                                 804 = 7345; 
                                 805 = 8224; 
                                 809 = 8251; 
                                 811 = 7322; 
                                 812 = 7321; 
                                 813 = 8131; 
                                 814 = 7323; 
                                 819 = 8139; 
                                 821 = 8273; 
                                 822 = 7412; 
                                 823 = 8274; 
                                 824 = 8278; 
                                 825 = 9320; 
                                 826 = 7411; 
                                 827 = 8272; 
                                 828 = 8279; 
                                 829 = 8278; 
                                 831 = 8159; 
                                 832 = 8151; 
                                 833 = 8151; 
                                 834 = 8231; 
                                 835 = 8232; 
                                 839 = 8159; 
                                 841 = 8142; 
                                 842 = 8143; 
                                 843 = 8253; 
                                 849 = 8142; 
                                 851 = 7129; 
                                 852 = 8265; 
                                 853 = 7312; 
                                 854 = 7113; 
                                 859 = 7222; 
                                 861 = 8161; 
                                 869 = 8161; 
                                 871 = 8333; 
                                 872 = 8332; 
                                 873 = 8334; 
                                 879 = 9330; 
                                 881 = 9320; 
                                 882 = 9330; 
                                 889 = 9320; 
                                 891 = 9151; 
                                 901 = 5161; 
                                 902 = 9162; 
                                 903 = 5162; 
                                 904 = 3441; 
                                 905 = 5163; 
                                 906 = 5169; 
                                 909 = 5169; 
                                 911 = 1225; 
                                 912 = 5122; 
                                 913 = 5123; 
                                 914 = 5123; 
                                 915 = 4222; 
                                 916 = 5111; 
                                 919 = 5123; 
                                 921 = 5121; 
                                 929 = 5121; 
                                 931 = 9141; 
                                 932 = 9131; 
                                 939 = 9141; 
                                 941 = 5141; 
                                 942 = 5149; 
                                 949 = 5141; 
                                 951 = 9133; 
                                 952 = 9133; 
                                 959 = 9133; 
                                 961 = 3475; 
                                 971 = 5143; 
                                 979 = 5149; 
  981 = 110; 
  989 = 110")

#now merge the imputed SE ISCO 
newdata$ISCO88 <- ifelse(newdata$v3==10,newdata$isco88se,newdata$ISCO88)

newdata$egp <- occupar::isco88toEGP(newdata$ISCO88, self.employed = newdata$v110, n.employees = newdata$v108)

newdata <- newdata %>%
  mutate(
    egp6 = car::recode(egp, recodes = '"I     Service class I" = "Service I";"II    Service class II" = "Service II"; "III.a Routine non-manual, higher grade" = "Routine"; "III.b Routine non-manual, lower grade" = "Routine"; "IV.a  Self-employed with employees" = "Self"; "IV.b  Self-employed with no empoyees" = "Self"; "IV.c  Self-employed Farmers etc" = "Self"; "V     Manual supervisors/Lower grade technicians" = "Skilled";"VI    Skilled workers" = "Skilled"; "VII.a Unskilled workers" = "Unskilled"; "VII.b Farm labours" = "Unskilled"')
  ) #V Manual supervisors = Skilled in Svallfors' coding. It's another decision he made. 


tableA2 <- round(as.data.frame(sapply(list(10,9,2,6,1,16,17,5), function(x) {
  d <<- newdata[which(newdata$v3 == x),]
  tapply(d$govIndex,d$egp6, mean)
  })),2)
colnames(tableA2) <- c("Swe","Nor","Ger","Aut","Aus","NZ","Can","USA")
knitr::kable(tableA2,format="html", digits = round(2))
```
```{r}

newdata$female<-car::recode(newdata$v99, recodes = '1=0; 2=1')
newdata$empl<-car::recode(newdata$v104, recodes = '1:3=0; 5=1; c(4,6,8,9,10)=3; 7=2')

newdata$unskilled<-car::recode(newdata$egp6, recodes = '"Service I"=4; "Service II"=3; "Routine"=2; "Self"=5; "Skilled"=1;"Unskilled"=0')

m1nor<- lm(govIndex~female+factor(unskilled)+factor(empl),data = newdata, subset = (v3 %in% c(9)))

m1ger<- lm(govIndex~female+factor(unskilled)+factor(empl),data = newdata, subset = (v3 %in% c(2)))

m1aus<- lm(govIndex~female+factor(unskilled)+factor(empl),data = newdata, subset = (v3 %in% c(1)))

m1usa<- lm(govIndex~female+factor(unskilled)+factor(empl),data = newdata, subset = (v3 %in% c(5)))


table4<- stargazer(m1nor, m1ger, m1aus, m1usa, title= "Table 4",type = "text", single.row = TRUE, report = "vc*", star.cutoffs = c(0.05,0.01,0.001), covariate.labels = c("Female", "Skilled", "Routine non-manual", "Service class II", "Service class I", "Self-employed", "Unemployed", "Retired", "Others not in labor force"), column.labels = c("Norway", "Germany", "Australia", "USA"))

#to make it a file

table4 %>% paste(., collapse="\n") %>% cat("\n")

newdata2<- subset(newdata,v3==5)

gmean<-tapply(newdata2$govIndex,newdata2$egp,mean)
gsd<-tapply(newdata2$govIndex,newdata2$egp,sd)
tableA2<-as.data.frame(rbind(gmean,gsd))

knitr::kable(tableA2,format="html", digits = round(2), caption = "Table A2")
```

