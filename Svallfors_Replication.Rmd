---
title: "R Notebook"
output:
  pdf_document: default
  html_notebook: default
---
**This is a replication of Svallfors (1997)** 

**Research Question:** How are attitudes to redistribution structured in various welfare state regimes?

**Data:** ISSP, wave of 1992, module on Social Inequality 

**Country Cases:** Swe, Nor, Ger, Aut, Aus, Nz, Can, USA

```{r}
rm(list = ls())
```


```{r setup,include=FALSE}

library(dplyr)
library(pacman)
library(ltm)

pacman::p_load("tidyverse","knitr","haven","car","plyr","data.table","expss","htmlTable","magrittr","ltm","questionr","survey","remotes")

#remotes::install_github("DiogoFerrari/occupar")
library(occupar)


wd <- "S:/Shared with groups/Public Opinion and Social Policy/Hung's/OpPol/Data/ISSP/Social Inequality/"

```


This is where we import the data

```{r readdata, include=FALSE}
socIn92 <- read_dta(paste(wd,"ZA2310.dta",sep=""))

```

In the following we replicate the operationalization of the independent variable of this study: attitudes to redistribution. 

3 questions/variables from the survey are used: 

1. It is the responsibility of the government to reduce the differences between people with high incomes and those with low incomes? --> v57

2. The government should provide a job for everyone who wants one? --> v59

3. The government should provide everyone with a guaranteed basic income? --> v62

Furthermore, we reconstruct the variable "government index" as follows: 

*“For this purpose, an additive index was constructed from the three items, dividing between 'strongly agree' and 'agree' (2); 'neither agree nor disagree' (1); and ‘disagree' and 'strongly disagree' (0). These items were summed, creating an index which may vary between 0 and 6, where 0 means disagreeing with all three propositions and thereby endorsing a clear-cut anti-interventionist stand and 6 means a strong interventionist standpoint“* (Svallfors 1997: 289). 

Having created and recoded theses 4 variables, we replicate table 1 and table 2 of his study.

This is how we proceed in detail: 
```{r}
#First we copy the dataset (first line). Now we have the original version (SocIn92) and a copied version with which we can work (SocIn92recode). In the latter we create new variables (dplyr:mutate) by recoding (car::recode) the above mentioned variables following Svallfors . 

socIn92recode <- socIn92 %>%  
  dplyr::mutate(
    r1= car::recode(socIn92$v57,recodes = '1:2=2; 3=1; 4:5=0'),
    r2= car::recode(socIn92$v59,recodes = '1:2=2; 3=1; 4:5=0'),
    r3= car::recode(socIn92$v62,recodes = '1:2=2; 3=1; 4:5=0'),
      
#Here we create Svallfors additive index "govermental index". Cases with at least one                               NA value are automatically excluded. 

     govIndex = r1+ r2+ r3,   

#to measure the percentage of people agreeing (answer category 1 and 2). Needed for table 1.     
 
    r1p= car::recode(socIn92$v57,recodes = '1:2=100; 3:5=0'), 
    r2p= car::recode(socIn92$v59,recodes = '1:2=100; 3:5=0'),
    r3p= car::recode(socIn92$v62,recodes = '1:2=100; 3:5=0')
  )%>%
  
#Now we reduce our dataset to the countries Svallfors includes in his analysis (dyplr:filter).
  
   dplyr::filter(
     v3 %in% c(2,5,17,6,1,16,9,10)  
     )

 #We remove all cases with NA values in the variables (complete.cases)

socIn92recode<-socIn92recode[complete.cases(socIn92recode$r1p),]
socIn92recode<-socIn92recode[complete.cases(socIn92recode$r2p),]
socIn92recode<-socIn92recode[complete.cases(socIn92recode$r3p),]

#Now that we have prepared our variables, we start constructing **table 1: Attitudes to redistribution in eight nations**:

#First, we creat vectors with the country means of our variables r1p, r2p, r3p (tapply).

govinc<-tapply(socIn92recode$r1p,socIn92recode$v3,mean) 
govjobs<-tapply(socIn92recode$r2p,socIn92recode$v3,mean)
govbas<-tapply(socIn92recode$r3p,socIn92recode$v3,mean)


#We make a table in form of a dataframe with the just created vectors (rbind) and sort the columns of the table following Svallfors.

table1<-as.data.frame(rbind(govinc,govjobs,govbas))
table1<-table1[,c(6,5,2,4,1,7,8,3)]   


# We creat a vector with the country names in the same order (->cnt) and a vector with the questions belonging to the variables (-> item.table1). The first is used as column names, the latter as row names. 

cnt<-c("Swe","Nor","Ger","Aut","Aus","NZ","Can","USA") 
item.table1<-c("It is the responsibility of the government to reduce the differences between people with high incomes and those with low incomes?","The government should provide a job for everyone who wants one?","The government should provide everyone with a guaranteed basic income?")

row.names(table1)<-item.table1
colnames(table1) = cnt
#Finally, we creat a HTML table (knitr:kable).

knitr::kable(table1,format="html", digits = round(1), caption = "Table 1. Attitudes to redistribution in eight nations. Percentage agreeing with certain propositions")




```
```{r}
#Lisa's way for table 1 with weights 

socIn92recode<-socIn92recode %>%
  group_by(v3)%>% 
  dplyr::mutate(
    wmean_r1p = weighted.mean(r1p,v176),
    wmean_r2p = weighted.mean(r2p,v176),
    wmean_r3p = weighted.mean(r3p,v176))

govinc_w<-tapply(socIn92recode$wmean_r1p,socIn92recode$v3,mean) 
govjobs_w<-tapply(socIn92recode$wmean_r2p,socIn92recode$v3,mean)
govbas_w<-tapply(socIn92recode$wmean_r3p,socIn92recode$v3,mean)  

table1_w<-as.data.frame(rbind(govinc_w,govjobs_w,govbas_w))
table1_w<-table1_w[,c(6,5,2,4,1,7,8,3)]  

row.names(table1_w)<-item.table1
colnames(table1_w) = cnt

knitr::kable(table1_w,format="html", digits = round(1), caption = "Table 1 (with weights). Attitudes to redistribution in eight nations. Percentage agreeing with certain propositions")
```

```{r}
#Hung's way for table 1 with weights
table1.2 <- round(as.data.frame(sapply(list(10,9,2,6,1,16,17,5), function(x) {
  d <<- socIn92recode[which(socIn92recode$v3 == x),]
  sapply(list(d$r1p,d$r2p,d$r3p), function(y) weighted.mean(y,d$v176)
  )})),2)
colnames(table1.2) <- c("Swe","Nor","Ger","Aut","Aus","NZ","Can","USA")

```


```{r}

#Here we replicate **tabel 2: Index distribution**  in the same way we constructed table 1. 

#mean and standard deviation 
govIndexmean<-tapply(socIn92recode$govIndex,socIn92recode$v3,mean)
govIndexsd<-tapply(socIn92recode$govIndex,socIn92recode$v3,sd)

#cronbach's alpha by country (here for the recoded variable r1,r2,r3 = 394:396!)
a <- list(1,2,5,6,9,10,16,17)
cronalpha <- round(unlist(as.data.frame(sapply(a, function(x) {
  c <-socIn92recode[which(socIn92recode$v3 == x),c(394:396)]
  cronbach.alpha(c)
}))[1,]),2)
table2[3,] <- cronalpha

table2<-as.data.frame(rbind(govIndexmean,govIndexsd,cronalpha))
table2<-table2[,c(6,5,2,4,1,7,8,3)]

item.table2<-c("Mean","Standard Deviation", "Cronbach's alpha")
row.names(table2)<- item.table2
colnames(table2)<- cnt 


knitr::kable(table2,format="html", digits = round(2), caption = "Table 2. Government Index. Distributions")



```


```{r}
#Now we want to compare our results for table 1 with the results of Svallfors 

#Here we create a copy of table 1 with the original values of Svallfors

table1Sval<-data.frame(matrix(c(53.7,74.1,45.5,60.0,78.3,78.4,65.5,66.3, 58.1,69.5,72.1,51.2, 42.6, 39.4, 50.9, 53.1, 49.1, 60.5, 47.9, 40.1, 48.6, 38.3, 47.1, 34.2),nrow = 3,ncol = 8))
row.names(table1Sval)<-item.table1
colnames(table1Sval) = cnt

#Here we show the deviations of our replicated table (table1) and the original table (table1Sval).
table1diff <- round(table1 - table1Sval,1)

#Here we show the deviations of our replicated table (table1 with weights) and the original table (table1Sval).

table1diff_w <- round(table1_w - table1Sval,1)
```



```{r}
#here we replicate the class scheme


socIncum <- read_dta(paste(wd, "ZA5890_v1-0-0.dta", sep = ""))
socIn92new <- socIncum[which(socIncum$V5 %in% c(752, 578, 276, 40, 36, 554, 124, 840) & socIncum$V4 == 1992),]
socIn92new <- socIn92new[,c("V3","ISCO88")]

socIn92new <- dplyr::rename(socIn92new, v2 = V3)

newdata <- as.data.frame(left_join(socIn92recode, socIn92new, by = "v2"))

newdata$v110 <- car::recode(newdata$v110, recodes = '2=0')

newdata$egp <- occupar::isco88toEGP(newdata$ISCO88, self.employed = newdata$v110, n.employees = newdata$v108)

newdata <- newdata %>%
  mutate(
    egp6 = car::recode(egp, recodes = '"I     Service class I" = "Service I";"II    Service class II" = "Service II"; "III.a Routine non-manual, higher grade" = "Routine"; "III.b Routine non-manual, lower grade" = "Routine"; "IV.a  Self-employed with employees" = "Self"; "IV.b  Self-employed with no empoyees" = "Self"; "IV.c  Self-employed Farmers etc" = "Self"; "V     Manual supervisors/Lower grade technicians" = "Skilled";"VI    Skilled workers" = "Skilled"; "VII.a Unskilled workers" = "Unskilled"; "VII.b Farm labours" = "Unskilled"')
  ) #V Manual supervisors = Skilled in Svallfors' coding. It's another decision he made. 


table1.3 <- round(as.data.frame(sapply(list(10,9,2,6,1,16,17,5), function(x) {
  d <<- newdata[which(newdata$v3 == x),]
  tapply(d$govIndex,d$egp6, mean)
  })),2)
colnames(table1.3) <- c("Swe","Nor","Ger","Aut","Aus","NZ","Can","USA")

#Check the EGP values of Sweden
unique(newdata[which(newdata$v3 == 10),]$ISCO88)


```

