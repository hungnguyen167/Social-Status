---
title: "R Notebook"
output:
  pdf_document: default
  html_notebook: default
---
**This is a replication of Svallfors (1997)** 

**Research Question:** How are attitudes to redistribution structured in various welfare state regimes?

**Data:** ISSP, wave of 1992, module on Social Inequality 

**Country Cases:** Swe, Nor, Ger, Aut, Aus, Nz, Can, USA

```{r}
rm(list = ls())
```


```{r setup,include=FALSE}

library(dplyr)
library(pacman)
library(ltm)

pacman::p_load("tidyverse","knitr","haven","car","plyr","data.table","expss","htmlTable","magrittr","ltm","questionr","survey","remotes")

remotes::install_github("DiogoFerrari/occupar")
library(occupar)


wd <- "S:/Shared with groups/Public Opinion and Social Policy/Hung's/OpPol/Data/ISSP/Social Inequality/"

```


This is where we import the data

```{r readdata, include=FALSE}
socIn92 <- read_dta(paste(wd,"ZA2310.dta",sep=""))

```

In the following we replicate the operationalization of the independent variable of this study: attitudes to redistribution. 

3 questions/variables from the survey are used: 

1. It is the responsibility of the government to reduce the differences between people with high incomes and those with low incomes? --> v57

2. The government should provide a job for everyone who wants one? --> v59

3. The government should provide everyone with a guaranteed basic income? --> v62

Furthermore, we reconstruct the variable "government index" as follows: 

*“For this purpose, an additive index was constructed from the three items, dividing between 'strongly agree' and 'agree' (2); 'neither agree nor disagree' (1); and ‘disagree' and 'strongly disagree' (0). These items were summed, creating an index which may vary between 0 and 6, where 0 means disagreeing with all three propositions and thereby endorsing a clear-cut anti-interventionist stand and 6 means a strong interventionist standpoint“* (Svallfors 1997: 289). 

Having created and recoded theses 4 variables, we replicate table 1 and table 2 of his study.

This is how we proceed in detail: 
```{r}
#First we copy the dataset (first line). Now we have the original version (SocIn92) and a copied version with which we can work (SocIn92recode). In the latter we create new variables (dplyr:mutate) by recoding (car::recode) the above mentioned variables following Svallfors . 

socIn92recode <- socIn92 %>%  
  dplyr::mutate(
    r1= car::recode(socIn92$v57,recodes = '1:2=2; 3=1; 4:5=0'),
    r2= car::recode(socIn92$v59,recodes = '1:2=2; 3=1; 4:5=0'),
    r3= car::recode(socIn92$v62,recodes = '1:2=2; 3=1; 4:5=0'),
      
#Here we create Svallfors additive index "govermental index". Cases with at least one                               NA value are automatically excluded. 

     govIndex = r1+ r2+ r3,   

#to measure the percentage of people agreeing (answer category 1 and 2). Needed for table 1.     
 
    r1p= car::recode(socIn92$v57,recodes = '1:2=100; 3:5=0'), 
    r2p= car::recode(socIn92$v59,recodes = '1:2=100; 3:5=0'),
    r3p= car::recode(socIn92$v62,recodes = '1:2=100; 3:5=0')
  )%>%
  
#Now we reduce our dataset to the countries Svallfors includes in his analysis (dyplr:filter).
  
   dplyr::filter(
     v3 %in% c(2,5,17,6,1,16,9,10)  
     )

 #We remove all cases with NA values in the variables (complete.cases)

socIn92recode<-socIn92recode[complete.cases(socIn92recode$r1p),]
socIn92recode<-socIn92recode[complete.cases(socIn92recode$r2p),]
socIn92recode<-socIn92recode[complete.cases(socIn92recode$r3p),]

#Now that we have prepared our variables, we start constructing **table 1: Attitudes to redistribution in eight nations**:

#First, we creat vectors with the country means of our variables r1p, r2p, r3p (tapply).

govinc<-tapply(socIn92recode$r1p,socIn92recode$v3,mean) 
govjobs<-tapply(socIn92recode$r2p,socIn92recode$v3,mean)
govbas<-tapply(socIn92recode$r3p,socIn92recode$v3,mean)


#We make a table in form of a dataframe with the just created vectors (rbind) and sort the columns of the table following Svallfors.

table1<-as.data.frame(rbind(govinc,govjobs,govbas))
table1<-table1[,c(6,5,2,4,1,7,8,3)]   


# We creat a vector with the country names in the same order (->cnt) and a vector with the questions belonging to the variables (-> item.table1). The first is used as column names, the latter as row names. 

cnt<-c("Swe","Nor","Ger","Aut","Aus","NZ","Can","USA") 
item.table1<-c("It is the responsibility of the government to reduce the differences between people with high incomes and those with low incomes?","The government should provide a job for everyone who wants one?","The government should provide everyone with a guaranteed basic income?")

row.names(table1)<-item.table1
colnames(table1) = cnt
#Finally, we creat a HTML table (knitr:kable).

knitr::kable(table1,format="html", digits = round(1), caption = "Table 1. Attitudes to redistribution in eight nations. Percentage agreeing with certain propositions")




```
```{r}
#Lisa's way for table 1 with weights 

socIn92recode<-socIn92recode %>%
  group_by(v3)%>% 
  dplyr::mutate(
    wmean_r1p = weighted.mean(r1p,v176),
    wmean_r2p = weighted.mean(r2p,v176),
    wmean_r3p = weighted.mean(r3p,v176))

govinc_w<-tapply(socIn92recode$wmean_r1p,socIn92recode$v3,mean) 
govjobs_w<-tapply(socIn92recode$wmean_r2p,socIn92recode$v3,mean)
govbas_w<-tapply(socIn92recode$wmean_r3p,socIn92recode$v3,mean)  

table1_w<-as.data.frame(rbind(govinc_w,govjobs_w,govbas_w))
table1_w<-table1_w[,c(6,5,2,4,1,7,8,3)]  

row.names(table1_w)<-item.table1
colnames(table1_w) = cnt

knitr::kable(table1_w,format="html", digits = round(1), caption = "Table 1 (with weights). Attitudes to redistribution in eight nations. Percentage agreeing with certain propositions")
```



```{r}

#Here we replicate **tabel 2: Index distribution**  in the same way we constructed table 1. 

#mean and standard deviation 
govIndexmean<-tapply(socIn92recode$govIndex,socIn92recode$v3,mean)
govIndexsd<-tapply(socIn92recode$govIndex,socIn92recode$v3,sd)

#cronbach's alpha by country (here for the recoded variable r1,r2,r3 = 394:396!)
a <- list(1,2,5,6,9,10,16,17)
cronalpha <- round(unlist(as.data.frame(sapply(a, function(x) {
  c <-socIn92recode[which(socIn92recode$v3 == x),c(394:396)]
  cronbach.alpha(c)
}))[1,]),2)
table2[3,] <- cronalpha

table2<-as.data.frame(rbind(govIndexmean,govIndexsd,cronalpha))
table2<-table2[,c(6,5,2,4,1,7,8,3)]

item.table2<-c("Mean","Standard Deviation", "Cronbach's alpha")
row.names(table2)<- item.table2
colnames(table2)<- cnt 


knitr::kable(table2,format="html", digits = round(2), caption = "Table 2. Government Index. Distributions")



```


```{r}
#Now we want to compare our results for table 1 with the results of Svallfors 

#Here we create a copy of table 1 with the original values of Svallfors

table1Sval<-data.frame(matrix(c(53.7,74.1,45.5,60.0,78.3,78.4,65.5,66.3, 58.1,69.5,72.1,51.2, 42.6, 39.4, 50.9, 53.1, 49.1, 60.5, 47.9, 40.1, 48.6, 38.3, 47.1, 34.2),nrow = 3,ncol = 8))
row.names(table1Sval)<-item.table1
colnames(table1Sval) = cnt

#Here we show the deviations of our replicated table (table1) and the original table (table1Sval).
table1diff <- round(table1 - table1Sval,1)

#Here we show the deviations of our replicated table (table1 with weights) and the original table (table1Sval).

table1diff_w <- round(table1_w - table1Sval,1)
```



```{r}
#here we replicate the class scheme



socIn92recode$isco88<-car::recode(socIn92recode$v106, recodes = '010=211;011=211;012=211;013=211;014=311;020=214;021=214;022=214;023=214;024=214;025=214;026=214;027=214;028=214;029=214;030=311;031=214;032=311;033=311;034=311;035=311;036=311;037=311;038=311;039=311;040=314;041=314;041=314;042=314;043=314;050=221;051=221;052=221;053=221;054=321;060=222;061=222;062=322;063=222;064=322;065=222;066=322;067=222;068=322;069=322;070=223;071=223;072=323;073=223;074=323;075=322;076=322;077=313;078=322;079=322;080=212;081=212;082=212;083=213;084=213;090=244;110=241;120=242;121=242;122:124=242;129=242;013=211;130=230;131=231;132=232;133=233;134=233;135=234;139=235;140=246;141=212;149=212;150=245;151:152=245;159=245;160=245;161=245;162=347;163=313;170=347;171=245;172=245;173=245;174=122;175=347;179=347;180:182=347;190=240;191=243;192=244;193=346;194=241;195=244;196:199=200;2=110;200=111;201=112;202=111;203=112;210=130;211=120;212=122;219=123;220=120;300=123;310:312=344;320=411;321=411;322=411;330=343;331=421;339=412;340=312;341=411;342:343=312;350=413;351=122;352:353=122;359=413;360=511;369:373=414;380=422;380=422;390=410;391=413;392=413;393=410;394=413;395:397=414;399=414;400=131;410=131;420=123;421=123;422=341;430=341;431=341;432=341;440=341;441=341;442=342;443:444=341;450=520;451=522;452:454=911;490=520;500=131;510=120;520=512;530=512;531=512;532=512;540=513;541=513;550=914;551=914;552=714;560=826;570:571=514;580=516;581=516;582=345;583:587=345;589=343;590=510;591=511;592:594=514;599=915;600:602=131;610=613;611=613;612:615=613;620=921;621=921;622=921;623=921;624=921;625=921;626=921;627=921;628=833;629=610;630=921;631=614;632=914;;640=615;641=615;64=615;649=921;700=751;710=711;711=711;712=811;713=811;720=722;721=812;722=812;723=812;724=812;725=721;726=812;727:729=812;728=822;72=812;730=814;731=814;732=814;733=814;734=814;740=815;741=815;742=815;743=815;744=815;745=815;74=815;749=815;750=826;751=826;752=826;753=743;754=826;755=826;756=826;75=826;759=826;760=744;761=744;762=744;770=827;771=827;773=741;774=827;775=827;776=741;777=827;778=827;77=827;779=741;;780=827;781=827;782=827;783=827;78=827;789:790=743;791=743;792=743;793=743;794=743;795=743;796=743;079=222;;79=826;799=826;800=744;801=744;802=744;803=744;810=742;811=742;812=824;81=742;819=742;820=711;830=722;831=722;832=722;833=722;834=821;835:836=722;83=722;840=723;841=828;842=731;843=723;844=723;84=723;849=723;850=724;851=724;852=724;853=828;854=724;855=713;856=724;857=724;85=724;859=724;860=313;861=313;862=313;870=721;871=713;872=721;873=721;874=721;878:880=731;890=732;891=732;892=732;893=813;894=732;895=732;89=813;899=813;900=823;901=823;902=823;910=825;920=734;921=734;922=825;923=734;924=734;925=734;926=734;927=822;92=734;929:930=724;931:932=714;93=714;939=714;940=752;941=731;942=742;943=821;94=733;948:949=840;950=712;951=712;952=712;953=713;954=712;955=713;956=713;957=713;95=712;959=714;960=816;961=816;96=816;969=816;970=933;971=933;972=721;973=833;974=833;97=833;979:980=832;981=834;982=816;983=831;984=831;985=334;986=933;98=832;988:989=933;990:993=930;995=752;997:998=829;99=930;999=930')

table(c(socIn92recode$isco88, socIn92recode$v106))



socIn92recode$isco88<-socIn92recode$isco88*10


socIncum <- read_dta(paste(wd, "ZA5890_v1-0-0.dta", sep = ""))
socIn92new <- socIncum[which(socIncum$V5 %in% c(752, 578, 276, 40, 36, 554, 124, 840) & socIncum$V4 == 1992),]
socIn92new <- socIn92new[,c("V3","ISCO88")]

socIn92new <- dplyr::rename(socIn92new, v2 = V3)

newdata <- as.data.frame(left_join(socIn92recode, socIn92new, by = "v2"))

newdata$v110 <- car::recode(newdata$v110, recodes = '2=0')

newdata$egp <- occupar::isco88toEGP(newdata$ISCO88, self.employed = newdata$v110, n.employees = newdata$v108)

newdata <- newdata %>%
  mutate(
    egp6 = car::recode(egp, recodes = '"I     Service class I" = "Service I";"II    Service class II" = "Service II"; "III.a Routine non-manual, higher grade" = "Routine"; "III.b Routine non-manual, lower grade" = "Routine"; "IV.a  Self-employed with employees" = "Self"; "IV.b  Self-employed with no empoyees" = "Self"; "IV.c  Self-employed Farmers etc" = "Self"; "V     Manual supervisors/Lower grade technicians" = "Skilled";"VI    Skilled workers" = "Skilled"; "VII.a Unskilled workers" = "Unskilled"; "VII.b Farm labours" = "Unskilled"')
  ) #V Manual supervisors = Skilled in Svallfors' coding. It's another decision he made. 


table1.3 <- round(as.data.frame(sapply(list(10,9,2,6,1,16,17,5), function(x) {
  d <<- newdata[which(newdata$v3 == x),]
  tapply(d$govIndex,d$egp6, mean)
  })),2)
colnames(table1.3) <- c("Swe","Nor","Ger","Aut","Aus","NZ","Can","USA")
```

