---
title: "Social Status, Liberalization and Attitudes toward Redistribution"
output:
  html_document:
    df_print: paged
---
TO DO:
Soeren - could you add 2019 to the graphs?



Question - the inclarge question was not asked in the environment module I guess, so we drop it

Nate - get newer measure of socx from OECD, other macro-level variables (GDP in particular)


##### ISSP, Social Inequality, Cumulation (1987, 1992, 1999, 2009 & 2019)
##### ISSP, Environment, 1993, 2000 & 2010 (not asked, can't use)
$~$
$~$

#### **Nate Breznau, Lisa Heukamp & Hung H.V. Nguyen**
#### **University of Bremen**

_____________________________________________________________________________

$~$
$~$

Working paper available here: https://docs.google.com/document/d/1mST25rKYZ5wChRj5WyhxH_65RUa9MNR2OsO5B4-qcwY/edit#

Github repo: https://github.com/hungnguyen167/Social-Status



```{r, include = F}
rm(list = ls())
```


```{r setup, include=FALSE}
library(pacman)
pacman::p_load("tidyverse",
               "knitr",
               "lavaan",
               "kableExtra",
               "semTools",
               "ggplot2",
               "ragg",
               "sjPlot",
               "lme4",
               "readxl")

knitr::opts_chunk$set(message = F, warning = F)

```



## Load Data

The data cleaning is done in the file "01_Data Cleaning.Rmd" and country-data prepped in folder [prep country level data](../data/prep country level data/).

```{r loaddata, message = F, warning = F}
# ISSP Data
load(here::here("data","socstat.Rda"))

# Social spending data
socx <- read_csv(here::here("data","socx_oecd.csv"))

# Gini data
gini <- read_csv(here::here("data","gini_solt.csv"))

# WVS data aggregated
wvs <- read_csv(here::here("data","wvs_aggregated.csv")) %>%
  mutate(iso3c = COUNTRY_ALPHA,
         wave = case_when(
           year %in% c(1980:1989) ~ 1987,
           year %in% c(1990:1995) ~ 1992,
           year %in% c(1996:2005) ~ 1999,
           year %in% c(2006:2015) ~ 2009,
           year %in% c(2016:2020) ~ 2019,
           TRUE ~ NA_real_)) %>% # fit years of WVS into nearest wave of ISSP 1987, 1992, 1999, 2009, 2019
  select(-c(COUNTRY_ALPHA,year)) 

# Institutional Logic - welfare state penetration
#gwip <- 

# GDP and Democracy v Authoritarian from V-Dem (some interpolation, see Breznau and Lanver 2021)
gdp <- read_csv(here::here("data","vdem_gdp_pc_INTERPOLATED_consolidated.csv")) %>%
  mutate(iso3c = iso3) %>%
  select(-c(iso3, cow_code, country_name))
regime <- read_csv(here::here("data","vdem_regime__INTERPOLATED_consolidated.csv")) %>%
  mutate(iso3c = iso3) %>%
  select(-c(iso3, cow_code, country_name))
  
# Corruption perceptions
crpt <- read_csv(here::here("data","crpt.csv"))

```



```{r merge}

# Take averages of social spending and Gini to get the most possible countries
socx_19 <- socx %>%
  subset(year > 2010) %>%
  group_by(iso3c, year) %>%
  summarise_all(mean, na.rm = T) %>%
  mutate(year = 2019)

socx_20 <- socx %>%
  subset(year > 2010) %>%
  group_by(iso3c, year) %>%
  summarise_all(mean, na.rm = T) %>%
  mutate(year = 2020)

gini_19 <- gini %>%
  subset(year == 2017) %>%
  mutate(year = 2019)

gini_20 <- gini %>%
  subset(year == 2017) %>%
  mutate(year = 2020)

socx <- rbind(socx, socx_19, socx_20)
gini <- rbind(gini, gini_19, gini_20)

# extract WVS vars

df <- df %>%
  left_join(gini, by = c("iso3c","year")) %>%
  left_join(socx, by = c("iso3c","year")) %>%
  left_join(crpt, by = c("iso3c")) %>%
  left_join(wvs, by = c("iso3c", "wave")) %>%
  left_join(gdp, by = c("iso3c", "year")) %>%
  left_join(regime, by = c("iso3c", "year"))

rm(gini,socx,crpt)
```


```{r wrangle}
# make a complete data frame
df <- df %>%
  group_by(iso3c) %>%
  # calculate the mean for each country
  mutate(incdiff_b = mean(incdiff, na.rm = T),
         inclarge_b = mean(inclarge, na.rm = T),
         reduce_b = mean(reduce, na.rm = T),
         reduce_large_b = mean(reduce_large, na.rm = T)) %>%
  ungroup() %>%
  # calculate the mean-centered values by subtracting the means
  mutate(incdiff_w = incdiff - incdiff_b,
         inclarge_w = inclarge - inclarge_b,
         reduce_w = reduce - reduce_b,
         reduce_large_w = reduce_large - reduce_large_b)

df_na <- df %>%
  subset(!is.na(incdiff) & !is.na(inclarge))
```

There is some missing data
identify and fill in

```{r missing_wrangle}
df_na %>%
  dplyr::select(iso3c, year, socx, gini_disp) %>%
  group_by(iso3c, year) %>%
  summarise_all(mean, na.rm = T)

#fill in a few by hand
df_na <- df_na %>%
  mutate(socx = ifelse(iso3c == "AUT" & year == 1988, 24, socx),
         socx = ifelse(iso3c == "BGR" & year == 1993, 25, socx),
         socx = ifelse(iso3c == "BGR" & year == 1999, 38, socx),
         socx = ifelse(iso3c == "BGR" & year == 2009, 40, socx),
         socx = ifelse(iso3c == "CHE" & year == 1987, 10, socx),
         socx = ifelse(iso3c == "CHE" & year == 2009, 22, socx),
         socx = ifelse(iso3c == "CYP" & year == 1999, 18, socx),
         socx = ifelse(iso3c == "CYP" & year == 2009, 25, socx),
         socx = ifelse(iso3c == "HRV" & year == 2019, 30, socx),
         socx = ifelse(iso3c == "JPN" & year == 2019, 25, socx),
         socx = ifelse(iso3c == "NZL" & year == 2020, 25, socx),
         socx = ifelse(iso3c == "SVN" & year == 2020, 21, socx),
         socx = ifelse(iso3c == "ZAF" & year == 2018, 25, socx),
         socx = ifelse(iso3c == "ZAF" & year == 2019, 25, socx),
         socx = ifelse(iso3c == "HUN" & year == 1987, 20, socx),
         socx = ifelse(iso3c == "HUN" & year == 1992, 35, socx),
         socx = ifelse(iso3c == "HUN" & year == 1998, 40, socx),
         gini_disp = ifelse(iso3c == "PHL" & year == 2019, 42, gini_disp),
         gini_disp = ifelse(iso3c == "PHL" & year == 2019, 42, gini_disp),
         gini_disp = ifelse(iso3c == "JPN" & year == 2019, 35, gini_disp),
         gini_disp = ifelse(iso3c == "ZAF" & year == 2018, 50, gini_disp),
         gini_disp = ifelse(iso3c == "ZAF" & year == 2019, 50, gini_disp),
         gdp_pc_10k = filled_vdem_gdp_interpol/10000) # make a GDP 10k var

# just take the max value for 2019

# fill in WVS values for missing waves by country
df_na <- df_na %>%
  group_by(iso3c) %>%
  mutate(liberal_i = ifelse(is.na(liberal), mean(liberal, na.rm = T), liberal), 
         confidence_gov_i = ifelse(is.na(confidence_gov), mean(confidence_gov, na.rm = T), confidence_gov),
         freedom_gov_i = ifelse(is.na(freedom_gov), mean(freedom_gov, na.rm = T), freedom_gov),
         democratic_i = ifelse(is.na(democratic), mean(democratic, na.rm = T), democratic),
         reason_neediness_i = ifelse(is.na(reason_neediness), mean(reason_neediness, na.rm = T), reason_neediness),
         system_rating_i = ifelse(is.na(system_rating), mean(system_rating, na.rm = T), system_rating),
         poverty_compare_i = ifelse(is.na(poverty_compare), mean(poverty_compare, na.rm = T), poverty_compare)) %>%
  ungroup()
```


## Descriptives

### Table 1. Cases by Country-Wave

```{r tbl1, include = T, echo = T}
# Run this if you still have the old socstat version
# df$female <- ifelse(df$female == 8, NA, df$female)


# Cross-tab years and countries
options(knitr.kable.NA = '')
tab1 <- df_na %>%
  dplyr::group_by(country, wave) %>%
  dplyr::summarize(n=n()) %>%
  spread(wave, n) %>%
  kable(., 
        #col.names = c("Country", "SI_1987", "SI_1992", "EN_1993", "SI_1999", "EN_2000", "SI_2009", "EN_2010", "SI_2019"), 
        caption = "Country Sample Size by Wave, ISSP 'Social Inequality (SI)", format.args = list(big.mark = ","))

kable_styling(tab1)
```

## Macro-Correlations


```{r var_dvs}
df_macro <- df_na %>%
  select(iso3c, wave, reduce, reduce_large, gini_disp, gini_mkt, socx, socx_perhead, cpi15_20, liberal_i, confidence_gov_i, democratic_i, gdp_pc_10k, regime)

df_macro_corr <- df_macro %>%
  select(-c(iso3c, wave)) %>%
  cor(., use = "pairwise.complete.obs") %>%
  as.data.frame() %>%
  round(.,2)
```

### Step Two - Variation incdiff/inclarge

```{r twovar_compare}

```

### Theory

After observing the variation in the correlation between inclarge and incdiff by country. We suspect that attitudes toward the role of government are in play. We suspect these come from institutionalized norms. 

Theory: individuals have values or follow norms about how much the government should intervene in the socio-economic affairs of individuals, how much the government should protect against social risks and how much the government (society) should share or redistribute based on need. 

Hypothesis: In countries where the government does less redistribution or has a weaker welfare state, the correlation between perceptions of the income gap and the idea that the government is responsible for doing something about it will be smaller.


Example: In the US the public may perceive a high or undesirable amount of income inequality, but be less likely to agree that the government should do something about it. Whereas in Germany the public may also perceive a high degree of inequality but be more likely to express that the government should do (is responsible) for doing something about it. 

### Multilevel Models
```{r mlms}
M00 <- lmer(reduce ~ 1 + (1 | iso3c), data = df_na)
M00.5 <- lmer(reduce ~ 1 + reduce_large + (1 | iso3c), data = df_na)
M01 <- lmer(reduce ~ 1 + reduce_large + (1 + reduce_large | iso3c), data = df_na)
M02 <- lmer(reduce ~ 1 + reduce_large*socx + (1 + reduce_large | iso3c), data = df_na)
M03 <- lmer(reduce ~ 1 + reduce_large*gini_disp + (1 + reduce_large | iso3c), data = df_na)

tab_model(M00, M00.5, M01, M02, M03, show.ci = F, p.style = "stars")

```

### Plot SOCX and slope

```{r}

```

