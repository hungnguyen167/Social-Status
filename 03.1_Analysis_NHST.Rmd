---
title: "Analysis NHST"
output:
  html_document:
    df_print: paged
---

TO DO:

Nate - get newer measure of socx from OECD, other macro-level variables (GDP in particular)


##### ISSP, Social Inequality, Cumulation (1987, 1992, 1999, 2009 & 2019)

$~$
$~$

#### **Nate Breznau, Lisa Heukamp, Hung H.V. Nguyen, Tom Knuf, Arne Köller, Sören Goldenstein**
#### **University of Bremen**

_____________________________________________________________________________

$~$
$~$




```{r, include = F}
rm(list = ls())
```


```{r setup, include=FALSE}
library(pacman)
pacman::p_load("tidyverse", "ggpubr", 
               "ragg", "kableExtra", 
               "lme4", 
               "sjPlot",
               "arm",
               "margins",
               "ggeffects")

knitr::opts_chunk$set(message = F, warning = F)

```


```{r load dfs}
#df <- readRDS(here::here("data","df.RDS"))
df_na <- readRDS(here::here("data", "df_na.RDS"))
df_macro <- readRDS(here::here("data", "df_macro.RDS"))

```


### All Plausible Models

#### Moderation models, for specification curve

Selection point. If we've run the models and the margins command before then this will not be necessary. 

NOTE: that if we make changes to the models we have to turn off the selector and re-run, or delete the df_ame file, or the if selection won't work!

```{r ameload}
if (file.exists(here::here("data", "df_ame.RDS"))) { 
  # select if this margins datafile is already there

   df_ame <- readRDS(here::here("data", "df_ame.RDS"))

    } else 
 { source(here::here("data", "Models_nomain.R"))
   model_list <- mget(ls(pattern = "M_"))
   #model_list_lm <- mget(ls(pattern = "L_"))
#########
   # Compile all M_ models margins (multilevel)   
   df_ame <- as.data.frame(matrix(nrow = length(model_list), ncol = 3))

colnames(df_ame) <- c("Model", "mod_b", "mod_se")

model_names <- names(model_list)

for (m in 1:length(model_list)) {
  
  #mn <- as.name(model_names[m])
  
  df_ame[m,1] <- paste(as.character(model_list[[m]]@call), sep = "", collapse = "")
  
  temp <- as.data.frame(summary(get(model_names[m]))[["coefficients"]])
  
  temp <- temp[grepl('cpiZ|noconf_govZ|libZ|lib_redistZ|incdiff_large', rownames(temp)), 1:2]
  
  df_ame[m,"mod_b"] <- temp[grepl(":", rownames(temp)),1]
  df_ame[m, "mod_se"] <- temp[grepl(":", rownames(temp)),2]
  
}


}
```

#### Get model specifications

```{r ameclean}
df_ame <- df_ame %>%
  mutate(mod_var = ifelse(grepl("noconf_govZ", Model, fixed = T), "B_No_confidence", 
                   ifelse(grepl("cpiZ", Model), "C_Corruption_percept",
                   ifelse(grepl("libZ", Model), "A1_Liberal_values", "A2_Liberal_values"))),
         mod_imputed = ifelse(grepl("_i", df_ame$Model), "Yes", "No"),
         ri_cyear = ifelse(grepl("iso3c_wave", df_ame$Model), "Yes", "No"),
         ri_country = ifelse(grepl("iso3c)", df_ame$Model), "Yes", "No"),
         estimation = ifelse(grepl("lmer", df_ame$Model), "GLM", "OLS"),
         control_gdp = ifelse(grepl("gdp", df_ame$Model), "Yes", "No"),
         control_gini = ifelse(grepl("gini", df_ame$Model), "Yes", "No"),
         control_socx = ifelse(grepl("socx", df_ame$Model), "Yes", "No"),
         control_fb = ifelse(grepl("pct_fb", df_ame$Model), "Yes", "No"),
         i_level_control = ifelse(grepl("female", df_ame$Model), "Yes", "No"),
         gdp_m_interaction = ifelse(grepl(":gdp_pc_10k_C", df_ame$Model), "Yes", "No")
         )

df_ame <- df_ame %>%
  arrange(mod_b) %>%
  mutate(count = row_number())

saveRDS(df_ame, here::here("data", "df_ame.RDS"))

```

Get Bayes specifications

The Bayes models were produced by the file [Models_nomain.R](../data/Models_nomain.R) and saved as [bayesian_mods.RData](../data/bayesian_mods.RData) as they consume a considerable amount of time to run depending on processor. If the user sucessfully passed the above code and produced df_ame, then they also produced Bayes models. Here we simply load the models and create a dataframe of those results, again selecting if this already exists or not.
```{r bayesame}

if (file.exists(here::here("data", "df_ame_bayes.RDS"))) { 
  df_ame_bayes <- readRDS(here::here("data", "df_ame_bayes.RDS"))

    } else 
 { 
   load(here::here("data", "bayesian_mods.RData"))
   
model_list_bayes <- ls(pattern="M_b")

df_ame_bayes <- as.data.frame(matrix(nrow = length(model_list_bayes), ncol = 3))

colnames(df_ame_bayes) <- c("formula", "mod_b", "mod_se")
rownames(df_ame_bayes) <- model_list_bayes
count <- 1
for (m in model_list_bayes) {
  
  #mn <- as.name(model_names[m])
  model <- get(m)
  
  f <- model[["formula"]][["formula"]]
  df_ame_bayes[count,"formula"] <- paste(as.character(f[2]), as.character(f[1]), as.character(f[3]))
 
  # Hung, can you get the coefficients here? They are not named in the summary object as far as I can tell... 
  temp <- as.data.frame(fixef(model))
  
  temp <- temp[grepl('cpiZ|noconf_govZ|libZ|lib_redistZ|incdiff_large', rownames(temp)), 1:2]
  
  df_ame_bayes[count,"mod_b"] <- temp[grepl(":", rownames(temp)),1]
  df_ame_bayes[count, "mod_se"] <- temp[grepl(":", rownames(temp)),2]
  count <- count + 1
}

df_ame_bayes <- df_ame_bayes %>%
  mutate(mod_var = ifelse(grepl("noconf_govZ", Model, fixed = T), "B_No_confidence", 
                   ifelse(grepl("cpiZ", Model), "C_Corruption_percept",
                   ifelse(grepl("libZ", Model), "A1_Liberal_values", "A2_Liberal_values"))),
         mod_imputed = ifelse(grepl("_i", df_ame_bayes$Model), "Yes", "No"),
         ri_cyear = ifelse(grepl("iso3c_wave", df_ame_bayes$Model), "Yes", "No"),
         ri_country = ifelse(grepl("iso3c)", df_ame_bayes$Model), "Yes", "No"),
         estimation = "Bayes",
         control_gdp = ifelse(grepl("gdp", df_ame_bayes$Model), "Yes", "No"),
         control_gini = ifelse(grepl("gini", df_ame_bayes$Model), "Yes", "No"),
         control_socx = ifelse(grepl("socx", df_ame_bayes$Model), "Yes", "No"),
         control_fb = ifelse(grepl("pct_fb", df_ame_bayes$Model), "Yes", "No"),
         i_level_control = ifelse(grepl("female", df_ame_bayes$Model), "Yes", "No"),
         gdp_m_interaction = ifelse(grepl(":gdp_pc_10k_C", df_ame_bayes$Model), "Yes", "No")
         )

df_ame_bayes <- df_ame_bayes %>%
  arrange(mod_b) %>%
  mutate(count = row_number())

saveRDS(df_ame_bayes, here::here("data", "df_ame_bayes.RDS"))
}

```




Colophon

```{r colophon}
sessionInfo()
```