---
title: "Attitudes toward Redistribution"
output:
  html_document:
    df_print: paged
---

```{r setup}
library(pacman)
pacman::p_load("tidyverse",
               "knitr",
               "lavaan",
               "kableExtra",
               "semTools",
               "ggplot2",
               "ragg",
               "sjPlot",
               "lme4",
               "readxl")

knitr::opts_chunk$set(message = F, warning = F)
```



The data cleaning is done in the file "01.1_Data Cleaning Individual Level.Rmd" and country-data prepped in folder [prep country level data](../data/prep country level data/).

```{r loaddata, message = F, warning = F}
# ISSP Data
load(here::here("data","socstat.Rda"))

# Social spending data
socx <- read_csv(here::here("data","socx_oecd.csv"))

# Gini data
gini <- read_csv(here::here("data","gini_solt.csv"))

# WVS data aggregated
wvs <- read_csv(here::here("data","wvs_aggregated.csv")) %>%
  mutate(iso3c = COUNTRY_ALPHA,
         wave = case_when(
           year %in% c(1980:1989) ~ 1987,
           year %in% c(1990:1995) ~ 1992,
           year %in% c(1996:2005) ~ 1999,
           year %in% c(2006:2015) ~ 2009,
           year %in% c(2016:2020) ~ 2019,
           TRUE ~ NA_real_)) %>% # fit years of WVS into nearest wave of ISSP 1987, 1992, 1999, 2009, 2019
  select(-c(COUNTRY_ALPHA,year)) 

# Institutional Logic - welfare state penetration
#gwip <- 

# GDP and Democracy v Authoritarian from V-Dem (some interpolation, see Breznau and Lanver 2021)
gdp <- read_csv(here::here("data","vdem_gdp_pc_INTERPOLATED_consolidated.csv")) %>%
  mutate(iso3c = iso3) %>%
  select(-c(iso3, cow_code, country_name))
regime <- read_csv(here::here("data","vdem_regime__INTERPOLATED_consolidated.csv")) %>%
  mutate(iso3c = iso3) %>%
  select(-c(iso3, cow_code, country_name))
  
# Corruption perceptions
crpt <- read_csv(here::here("data","crpt.csv"))

```



```{r merge}

# Take averages of social spending and Gini to get the most possible countries
socx_19 <- socx %>%
  subset(year > 2010) %>%
  group_by(iso3c, year) %>%
  summarise_all(mean, na.rm = T) %>%
  mutate(year = 2019)

socx_20 <- socx %>%
  subset(year > 2010) %>%
  group_by(iso3c, year) %>%
  summarise_all(mean, na.rm = T) %>%
  mutate(year = 2020)

gini_19 <- gini %>%
  subset(year == 2017) %>%
  mutate(year = 2019)

gini_20 <- gini %>%
  subset(year == 2017) %>%
  mutate(year = 2020)

socx <- rbind(socx, socx_19, socx_20)
gini <- rbind(gini, gini_19, gini_20)

# extract WVS vars

df <- df %>%
  left_join(gini, by = c("iso3c","year")) %>%
  left_join(socx, by = c("iso3c","year")) %>%
  left_join(crpt, by = c("iso3c")) %>%
  left_join(wvs, by = c("iso3c", "wave")) %>%
  left_join(gdp, by = c("iso3c", "year")) %>%
  left_join(regime, by = c("iso3c", "year"))

rm(gini,socx,crpt)
```


```{r wrangle}
# make a complete data frame
df <- df %>%
  group_by(iso3c) %>%
  # calculate the mean for each country
  mutate(incdiff_b = mean(incdiff, na.rm = T),
         inclarge_b = mean(inclarge, na.rm = T),
         reduce_b = mean(reduce, na.rm = T),
         reduce_large_b = mean(reduce_large, na.rm = T)) %>%
  ungroup() %>%
  # calculate the mean-centered values by subtracting the means
  mutate(incdiff_w = incdiff - incdiff_b,
         inclarge_w = inclarge - inclarge_b,
         reduce_w = reduce - reduce_b,
         reduce_large_w = reduce_large - reduce_large_b)

df_na <- df %>%
  subset(!is.na(incdiff) & !is.na(inclarge))
```

There is some missing data
identify and fill in

```{r missing_wrangle}
df_na %>%
  dplyr::select(iso3c, year, socx, gini_disp) %>%
  group_by(iso3c, year) %>%
  summarise_all(mean, na.rm = T)

#fill in a few by hand
df_na <- df_na %>%
  mutate(socx = ifelse(iso3c == "AUT" & year == 1988, 24, socx),
         socx = ifelse(iso3c == "BGR" & year == 1993, 25, socx),
         socx = ifelse(iso3c == "BGR" & year == 1999, 38, socx),
         socx = ifelse(iso3c == "BGR" & year == 2009, 40, socx),
         socx = ifelse(iso3c == "CHE" & year == 1987, 10, socx),
         socx = ifelse(iso3c == "CHE" & year == 2009, 22, socx),
         socx = ifelse(iso3c == "CYP" & year == 1999, 18, socx),
         socx = ifelse(iso3c == "CYP" & year == 2009, 25, socx),
         socx = ifelse(iso3c == "HRV" & year == 2019, 30, socx),
         socx = ifelse(iso3c == "JPN" & year == 2019, 25, socx),
         socx = ifelse(iso3c == "NZL" & year == 2020, 25, socx),
         socx = ifelse(iso3c == "SVN" & year == 2020, 21, socx),
         socx = ifelse(iso3c == "ZAF" & year == 2018, 25, socx),
         socx = ifelse(iso3c == "ZAF" & year == 2019, 25, socx),
         socx = ifelse(iso3c == "HUN" & year == 1987, 20, socx),
         socx = ifelse(iso3c == "HUN" & year == 1992, 35, socx),
         socx = ifelse(iso3c == "HUN" & year == 1998, 40, socx),
         gini_disp = ifelse(iso3c == "PHL" & year == 2019, 42, gini_disp),
         gini_disp = ifelse(iso3c == "PHL" & year == 2019, 42, gini_disp),
         gini_disp = ifelse(iso3c == "JPN" & year == 2019, 35, gini_disp),
         gini_disp = ifelse(iso3c == "ZAF" & year == 2018, 50, gini_disp),
         gini_disp = ifelse(iso3c == "ZAF" & year == 2019, 50, gini_disp),
         gdp_pc_10k = filled_vdem_gdp_interpol/10000) # make a GDP 10k var

# just take the max value for 2019

# fill in WVS values for missing waves by country
df_na <- df_na %>%
  group_by(iso3c) %>%
  mutate(liberal_i = ifelse(is.na(liberal), mean(liberal, na.rm = T), liberal), 
         confidence_gov_i = ifelse(is.na(confidence_gov), mean(confidence_gov, na.rm = T), confidence_gov),
         freedom_gov_i = ifelse(is.na(freedom_gov), mean(freedom_gov, na.rm = T), freedom_gov),
         democratic_i = ifelse(is.na(democratic), mean(democratic, na.rm = T), democratic),
         reason_neediness_i = ifelse(is.na(reason_neediness), mean(reason_neediness, na.rm = T), reason_neediness),
         system_rating_i = ifelse(is.na(system_rating), mean(system_rating, na.rm = T), system_rating),
         poverty_compare_i = ifelse(is.na(poverty_compare), mean(poverty_compare, na.rm = T), poverty_compare)) %>%
  ungroup()
```

```{r saveout}
# full data file
saveRDS(df, file = here::here("data","df.RDS"))
# with missing cases removed
saveRDS(df_na, file = here::here("data","df_na.RDS"))
```

